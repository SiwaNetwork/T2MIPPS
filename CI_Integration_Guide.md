# Руководство по интеграции CI интерфейса в T2MI PPS Generator

## Обзор

Данное руководство описывает интеграцию модуля условного доступа (CAM) через CI (Common Interface) интерфейс с 8-битной шиной данных согласно стандарту EN50221.

## Архитектура CI интерфейса

### Особенности реализации

1. **8-битная шина данных** вместо 16-битной PCMCIA
2. **Раздельные потоки данных**:
   - MDI (Media Data Input) - данные от CAM к хосту
   - MDO (Media Data Output) - данные от хоста к CAM
3. **Расширенная адресация** через дополнительные биты ci_a_ext[6:0]

### Основные компоненты

1. **ci_interface_8bit.v** - Модуль CI интерфейса
   - Управление 8-битной шиной данных
   - Раздельные медиа-потоки (MDI/MDO)
   - Машина состояний для активации CAM

2. **t2mi_pps_top_ci.v** - Главный модуль с CI интерфейсом
   - Интеграция CI интерфейса
   - Маршрутизация T2MI данных

## Сигналы CI интерфейса

### Управляющие сигналы

| Сигнал | Направление | Пин | Описание |
|--------|-------------|-----|----------|
| ci_reset | Выход | B1 | Сброс CAM модуля |
| ci_ce1_n | Выход | K1 | Card Enable (активный низкий) |
| ci_oe_n | Выход | K2 | Output Enable |
| ci_we_n | Выход | G1 | Write Enable |
| ci_reg_n | Выход | B14 | Register/Attribute Memory Select |
| ci_iord_n | Выход | J1 | I/O Read |
| ci_iowr_n | Выход | M2 | I/O Write |
| ci_ireq_n | Вход | A14 | Interrupt Request |
| ci_inpack_n | Вход | A12 | Input Acknowledge |
| bus_oe | Выход | A11 | Bus Output Enable |

### Адресная шина

- **ci_a[7:0]** - Основная 8-битная адресная шина (пины C7-A5)
- **ci_a_ext[6:0]** - Расширенные адресные биты (пины A3-B3)
- Полный адрес: {ci_a_ext, ci_a} = 15 бит

### Шина данных

- **ci_d[7:0]** - Двунаправленная 8-битная шина данных (пины N5-R3)

### Медиа интерфейс

#### Входной поток (MDI - от CAM к хосту)
- **ci_mdi[7:0]** - Данные (пины J2-C1)
- **ci_mclki** - Тактовый сигнал (пин M1)
- **ci_mival** - Валидность данных (пин F2)
- **ci_mistrt** - Начало пакета (пин L2)

#### Выходной поток (MDO - от хоста к CAM)
- **ci_mdo[7:0]** - Данные (пины P2-R1)
- **ci_mclko** - Тактовый сигнал (пин L1)
- **ci_moval** - Валидность данных (пин A13)
- **ci_mostrt** - Начало пакета (пин B12)

## Процесс активации CAM

### 1. Определение наличия модуля
```verilog
// Проверка сигналов ci_ireq_n и ci_inpack_n
cam_present_reg <= !ci_ireq_n && !ci_inpack_n;
```

### 2. Сброс модуля
```
STATE_RESET:
  - Активация ci_reset на 10 тактов
  - Ожидание 50 тактов для стабилизации
```

### 3. Чтение CIS
```
STATE_READ_CIS:
  - Чтение из Attribute Memory (ci_reg_n = 1)
  - Адрес начинается с 0x0000
  - Чтение 256 байт CIS данных
```

### 4. Инициализация
```
STATE_INIT:
  - Запись в Common Memory (ci_reg_n = 0)
  - Запись CMD_RESET в регистр команд (0x0204)
```

### 5. Согласование буфера
```
STATE_SIZE_NEG:
  - Запись размера буфера в регистры 0x0202-0x0203
  - Размер по умолчанию: 2048 байт
```

### 6. Рабочий режим
```
STATE_READY:
  - Готовность к передаче данных
  - Переход в STATE_STREAM_TX для отправки
  - Переход в STATE_STREAM_RX для приема
```

## Обработка потоков данных

### Передача данных к CAM (TX)

1. T2MI данные накапливаются в TX буфере
2. При наличии данных активируется передача:
   - Генерируется ci_mclko (тактовый сигнал)
   - Устанавливается ci_mostrt на первом такте
   - Данные выдаются побайтно с ci_moval = 1

### Прием данных от CAM (RX)

1. Детектируется ci_mistrt для начала приема
2. Данные захватываются по фронту ci_mclki при ci_mival = 1
3. Данные сохраняются в RX буфере
4. Конец пакета определяется по ci_mival = 0

## Временные диаграммы

### Чтение из CAM
```
ci_ce1_n  ‾‾‾\_______________/‾‾‾
ci_oe_n   ‾‾‾‾‾‾\_______/‾‾‾‾‾‾‾
ci_d[7:0] -----<  DATA  >--------
             ↑             ↑
           Setup         Hold
```

### Запись в CAM
```
ci_ce1_n  ‾‾‾\_______________/‾‾‾
ci_we_n   ‾‾‾‾‾‾\_______/‾‾‾‾‾‾‾
ci_d[7:0] =====< DATA >===========
```

### Медиа интерфейс (TX)
```
ci_mclko  _/‾\_/‾\_/‾\_/‾\_/‾\_
ci_mostrt _/‾‾‾\________________
ci_moval  ___/‾‾‾‾‾‾‾‾‾‾‾‾‾\___
ci_mdo    ---<D0><D1><D2><D3>---
```

## Конфигурация проекта

### Использование CI версии

1. Откройте `T2MI_PPS_Generator_CI.ldf` в Diamond Lattice
2. Убедитесь, что top-level модуль - `t2mi_pps_top_ci`
3. Используйте файл ограничений `constraints/t2mi_pps_ci.lpf`

### Режим обхода CAM

Сигнал `cam_bypass` позволяет обойти обработку CAM:
- cam_bypass = 0: Данные проходят через CAM
- cam_bypass = 1: Данные идут напрямую в парсер

## LED индикация

- **led_1** (D16) - Основной статус:
  - Мигает медленно: CAM не обнаружен
  - Мигает быстро: Инициализация
  - Горит постоянно: CAM активен

## Отладка

### Статусные регистры

**cam_status[7:0]**:
- Бит 0: CIS прочитан
- Бит 1: Инициализация завершена
- Бит 2: Буфер согласован
- Бит 6: Ошибка
- Бит 7: Готов к работе

### Типичные проблемы

1. **CAM не определяется**
   - Проверить ci_ireq_n и ci_inpack_n
   - Убедиться в правильном подключении

2. **Ошибка чтения CIS**
   - Проверить временные параметры
   - Убедиться в правильности адресации

3. **Нет передачи данных**
   - Проверить медиа-сигналы (mclki/mclko)
   - Проверить состояние буферов

## Преимущества 8-битной реализации

1. **Меньше пинов** - экономия ресурсов FPGA
2. **Раздельные потоки** - упрощенная буферизация
3. **Совместимость** - поддержка стандартных CAM модулей
4. **Гибкость** - независимая обработка входящих и исходящих данных

## Заключение

CI интерфейс с 8-битной шиной обеспечивает полную совместимость с EN50221 при более эффективном использовании ресурсов FPGA. Раздельные медиа-потоки упрощают управление данными и повышают надежность системы.