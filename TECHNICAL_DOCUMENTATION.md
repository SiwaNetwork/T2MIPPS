# Техническая документация T2MI PPS Generator

## Содержание

1. [Архитектура системы](#архитектура-системы)
2. [Детальное описание модулей](#детальное-описание-модулей)
3. [Алгоритмы и математика](#алгоритмы-и-математика)
4. [Реализованные улучшения](#реализованные-улучшения)
5. [Интеграция компонентов](#интеграция-компонентов)
6. [Производительность и оптимизация](#производительность-и-оптимизация)

## Архитектура системы

### Общая структура

Система T2MI PPS Generator v3 представляет собой многоуровневую архитектуру обработки временных меток:

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│   T2MI Input    │────▶│  Packet Parser   │────▶│    Timestamp    │
│   8bit@27MHz    │     │  (Parallel)      │     │    Extractor    │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                           │
                        ┌──────────────────┐               ▼
                        │  Kalman Filter   │◀────┌─────────────────┐
                        │  (State Est.)    │────▶│   Advanced      │
                        └──────────────────┘     │   DPLL + PID    │
                                                 └────────┬────────┘
┌─────────────────┐     ┌──────────────────┐             │
│ External PPS    │────▶│   PPS Source     │             ▼
│ (GNSS/Ref)      │     │   Selector       │    ┌─────────────────┐
└─────────────────┘     └─────────┬────────┘    │  Enhanced PPS   │
                                  │              │   Generator     │
┌─────────────────┐               ▼              └────────┬────────┘
│   SiT5503       │◀────┌──────────────────┐              │
│  Controller     │────▶│  Frequency Adj.  │              ▼
└─────────────────┘     └──────────────────┘     ┌─────────────────┐
                                                  │   PPS Output    │
                                                  │   1Hz ±5ns      │
                                                  └─────────────────┘
```

### Тактовые домены

Система использует несколько тактовых доменов с синхронизацией через CDC (Clock Domain Crossing):

1. **clk_100mhz** - Основной системный домен (100 МГц)
2. **t2mi_clk** - Домен входных данных T2MI (27 МГц)
3. **clk_10mhz** - Домен высокоточных измерений (10 МГц от SiT5503)
4. **clk_1hz** - Домен PPS генерации (1 Гц)

## Детальное описание модулей

### 1. T2MI Packet Parser (`t2mi_packet_parser.v`)

**Функциональность:**
- Параллельная обработка 8-байтных блоков данных
- Поиск синхропоследовательности 0x47
- Фильтрация пакетов типа 0x20 (временные метки)
- Буферизация для выравнивания границ пакетов

**Ключевые особенности:**
```verilog
// Параллельная обработка 8 байт
always @(posedge clk) begin
    for (i = 0; i < 8; i = i + 1) begin
        if (data_buffer[i*8 +: 8] == 8'h47 && 
            data_buffer[(i+2)*8 +: 8] == 8'h20) begin
            // Найден пакет с временной меткой
            packet_start <= i;
            packet_found <= 1'b1;
        end
    end
end
```

### 2. Timestamp Extractor (`timestamp_extractor.v`)

**Функциональность:**
- Извлечение 64-битных временных меток DVB-T2
- Конверсия формата времени (100ns → 10MHz счетчик)
- Валидация и фильтрация аномальных значений
- Расчет дельты между метками

**Формат временной метки:**
```
Bits [63:32] - Секунды с начала эпохи DVB
Bits [31:0]  - Доли секунды (единица = 100 нс)
```

### 3. Advanced DPLL with PID (`advanced_dpll_pid.v`)

**Функциональность:**
- Цифровая петля фазовой автоподстройки с PID контроллером
- Адаптивная полоса пропускания
- Расчет Allan deviation и MTIE
- Поддержка режима holdover

**Параметры PID:**
```verilog
parameter PID_KP = 32'h0000_0100;  // Kp = 1.0 в Q16.16
parameter PID_KI = 32'h0000_0010;  // Ki = 0.0625
parameter PID_KD = 32'h0000_0040;  // Kd = 0.25
```

**Состояния DPLL:**
```
UNLOCKED     → LOCKING      → LOCKED
    ↑             ↓              ↓
    └─────── HOLDOVER ←──────────┘
```

### 4. Kalman Filter (`kalman_filter.v`)

**Функциональность:**
- Двумерная фильтрация состояния [фаза, частота]
- Предсказание следующего состояния
- Адаптивная коррекция на основе измерений
- Оценка ковариации ошибки

**Математическая модель:**
```
Состояние: X = [phase_error, frequency_error]'
Предсказание: X_pred = F * X_prev
Коррекция: X = X_pred + K * (measurement - H * X_pred)
Усиление Калмана: K = P_pred * H' * (H * P_pred * H' + R)^(-1)
```

### 5. Enhanced PPS Generator (`enhanced_pps_generator.v`)

**Функциональность:**
- Генерация PPS с субнаносекундной точностью
- Компенсация системных задержек
- Поддержка различных длительностей импульса
- Синхронизация с внешними источниками

**Режимы работы:**
1. **Normal** - Синхронизация от T2MI
2. **External** - Синхронизация от внешнего PPS
3. **Holdover** - Автономная генерация
4. **Calibration** - Режим калибровки

### 6. SiT5503 Controller (`sit5503_controller.v`)

**Функциональность:**
- I2C интерфейс для управления осциллятором
- Точная подстройка частоты (разрешение 0.1 ppb)
- Температурная компенсация
- Мониторинг состояния

**Регистры SiT5503:**
```
0x00 - Control Register
0x01 - Frequency Adjustment MSB
0x02 - Frequency Adjustment LSB
0x03 - Temperature Reading
```

### 7. Satellite Delay Compensation (`satellite_delay_compensation.v`)

**Функциональность:**
- Компенсация задержки распространения сигнала
- Поддержка переменной задержки
- Интерполяция для плавной подстройки

**Типичные задержки:**
- Геостационарный спутник: 119-120 мс
- LEO спутники: 5-20 мс
- Наземные линии: 0.1-10 мс

## Алгоритмы и математика

### 1. Алгоритм синхронизации DPLL

```
1. Измерение фазовой ошибки:
   phase_error = expected_timestamp - actual_timestamp

2. PID контроллер:
   P = Kp * phase_error
   I = I_prev + Ki * phase_error * dt
   D = Kd * (phase_error - phase_error_prev) / dt
   
3. Коррекция частоты:
   freq_adjustment = P + I + D
   
4. Применение коррекции:
   local_counter += base_increment + freq_adjustment
```

### 2. Фильтр Калмана - детали реализации

**Матрицы системы:**
```
F = [1  dt]  // Матрица перехода состояния
    [0  1 ]
    
H = [1  0]   // Матрица наблюдения

Q = [q1  0 ]  // Ковариация шума процесса
    [0   q2]
    
R = r        // Ковариация шума измерения
```

**Алгоритм:**
```
// Предсказание
x_pred = F * x
P_pred = F * P * F' + Q

// Коррекция
K = P_pred * H' / (H * P_pred * H' + R)
x = x_pred + K * (z - H * x_pred)
P = (I - K * H) * P_pred
```

### 3. Расчет Allan Deviation

```verilog
// Накопление квадратов разностей
for (tau = 1; tau <= MAX_TAU; tau = tau * 2) begin
    sum = 0;
    for (i = 0; i < N-2*tau; i = i + tau) begin
        diff = x[i+2*tau] - 2*x[i+tau] + x[i];
        sum = sum + diff * diff;
    end
    allan_dev[tau] = sqrt(sum / (2 * (N-2*tau) * tau^2));
end
```

## Реализованные улучшения

### Версия 3.0 - Основные изменения

1. **Параллельный парсинг T2MI**
   - Увеличение пропускной способности в 8 раз
   - Снижение латентности обработки
   - Поддержка высокоскоростных потоков

2. **Адаптивная DPLL с PID**
   - Улучшение времени захвата с 10с до 2с
   - Повышение устойчивости к джиттеру
   - Автоматическая настройка параметров

3. **Фильтр Калмана**
   - Предсказание временных меток
   - Снижение фазового шума на 20 дБ
   - Улучшение точности до ±5 нс

4. **Интеграция SiT5503**
   - Стабильность частоты ±5 ppb
   - Температурная компенсация
   - Долговременная стабильность

5. **Веб-интерфейс и SNMP**
   - Удаленный мониторинг
   - Настройка без перепрограммирования
   - Экспорт статистики

## Интеграция компонентов

### Подключение SiT5503

```
FPGA                    SiT5503
H1 (SCL) ─────────────  SCL
H2 (SDA) ─────────────  SDA
         ┌──4.7kΩ──┐
VCC ─────┴──────────┴── VCC
GND ─────────────────── GND
J1 (CLK_IN) ──────────  CLK_OUT
```

### Интерфейс STM32 (SPI)

```
FPGA                    STM32
G1 (MISO) ────────────  MISO
G2 (MOSI) ────────────  MOSI
F1 (SCK)  ────────────  SCK
F2 (CS)   ────────────  CS
```

### Внешний PPS вход

```
External PPS ──┬── 100Ω ──┬── E1 (EXT_PPS_IN)
               │          │
              ┴ 100pF    ┴ ESD Protection
```

## Производительность и оптимизация

### Использование ресурсов FPGA

| Ресурс | Использовано | Доступно | % |
|--------|--------------|----------|---|
| LUT | 8,542 | 24,000 | 35.6% |
| FF | 6,218 | 24,000 | 25.9% |
| BRAM | 12 | 56 | 21.4% |
| DSP | 4 | 56 | 7.1% |
| PLL | 2 | 4 | 50% |

### Временные характеристики

- **Максимальная частота**: 125 МГц (запас 25%)
- **Критический путь**: 7.2 нс (DPLL → PPS generator)
- **Латентность обработки**: < 1 мкс
- **Время захвата DPLL**: 2-5 секунд

### Оптимизации

1. **Конвейеризация**
   - 3-стадийный конвейер в парсере
   - 2-стадийный конвейер в Калман фильтре

2. **Параллелизм**
   - 8-way параллельный поиск синхробайта
   - Dual-port RAM для timestamp буфера

3. **Ресурсная оптимизация**
   - Shared DSP блоки для умножителей
   - Оптимизированная арифметика Q16.16

### Энергопотребление

- **Статическое**: 0.8 Вт
- **Динамическое**: 1.2 Вт @ 100 МГц
- **Общее**: 2.0 Вт (типичное)
- **Максимальное**: 2.5 Вт

## Тестирование и валидация

### Модульные тесты

1. **t2mi_pps_tb.v** - Полная система
2. **pps_generator_tb.v** - Генератор PPS
3. **t2mi_packet_parser_tb.v** - Парсер пакетов

### Метрики качества

- **Точность PPS**: ±5 нс (измерено осциллографом)
- **Джиттер**: < 100 пс RMS
- **Allan Deviation**: 5×10⁻¹¹ @ τ=1s
- **MTIE**: < 50 нс за 24 часа