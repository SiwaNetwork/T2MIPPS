# Архитектурная документация T2MI PPS Generator v3

## Оглавление

1. [Обзор системы](#обзор-системы)
2. [Архитектурные принципы](#архитектурные-принципы)
3. [Структура модулей](#структура-модулей)
4. [Интерфейсы и протоколы](#интерфейсы-и-протоколы)
5. [Алгоритмы обработки](#алгоритмы-обработки)
6. [Синхронизация и тактирование](#синхронизация-и-тактирование)
7. [Управление состоянием](#управление-состоянием)
8. [Производительность и оптимизация](#производительность-и-оптимизация)

## Обзор системы

T2MI PPS Generator v3 - это высокоточная система генерации PPS (Pulse Per Second) сигнала на основе временных меток из потока T2-MI (T2 Modulator Interface). Система реализована на FPGA Lattice ECP5 и обеспечивает точность синхронизации ±10 нс.

### Основные функции

- **Параллельный парсинг T2-MI**: Обработка 8-байтных блоков данных на частоте 27 МГц
- **Извлечение временных меток**: Декодирование пакетов типа 0x20 с временными метками DVB-T2
- **Адаптивная DPLL**: Цифровая петля фазовой автоподстройки с фильтром Калмана
- **Интеграция GNSS**: Поддержка внешней синхронизации от GNSS приемника
- **Компенсация задержек**: Автоматическая компенсация системных и сетевых задержек
- **Многоуровневый мониторинг**: UART, SPI интерфейсы для диагностики и управления

### Целевая платформа

- **FPGA**: Lattice LFE5U-25F-6BG256C
- **Логические элементы**: 24,000 LUT
- **Встроенная память**: 1,032,192 бит
- **Количество I/O**: 197
- **Корпус**: CABGA-256

## Архитектурные принципы

### 1. Модульность
Система построена по модульному принципу с четким разделением функциональности:
- Каждый модуль выполняет одну специфическую функцию
- Минимизация межмодульных зависимостей
- Стандартизированные интерфейсы между модулями

### 2. Масштабируемость
- Параметризованная архитектура позволяет легко адаптировать систему
- Поддержка различных входных форматов данных
- Возможность добавления новых источников синхронизации

### 3. Надежность
- Резервирование критических компонентов
- Автоматическое переключение на резервные источники
- Обработка ошибок на всех уровнях

### 4. Производительность
- Параллельная обработка данных где возможно
- Оптимизация критических путей
- Эффективное использование ресурсов FPGA

## Структура модулей

### Иерархия верхнего уровня

```
t2mi_pps_top_v3
├── parallel_t2mi_parser
│   ├── sync_detector
│   ├── packet_extractor
│   └── crc_checker
├── timestamp_extractor
│   ├── packet_filter
│   ├── timestamp_decoder
│   └── validity_checker
├── enhanced_dpll
│   ├── phase_detector
│   ├── loop_filter
│   ├── nco
│   └── lock_detector
├── kalman_filter
│   ├── state_predictor
│   ├── measurement_updater
│   └── covariance_calculator
├── enhanced_pps_generator
│   ├── time_counter
│   ├── pulse_generator
│   └── output_selector
├── gnss_interface
│   ├── uart_receiver
│   ├── nmea_parser
│   └── pps_synchronizer
├── sit5503_controller
│   ├── i2c_master
│   ├── frequency_controller
│   └── status_monitor
├── stm32_interface
│   ├── spi_slave
│   ├── command_processor
│   └── status_reporter
├── delay_compensation
│   ├── delay_estimator
│   ├── compensation_calculator
│   └── adjustment_controller
├── edge_case_handler
│   ├── anomaly_detector
│   ├── recovery_controller
│   └── fallback_generator
└── uart_monitor
    ├── uart_transmitter
    ├── status_formatter
    └── command_receiver
```

### Описание основных модулей

#### 1. parallel_t2mi_parser
**Функция**: Параллельный парсинг потока T2-MI с обработкой 8 байт за такт

**Ключевые особенности**:
- Обнаружение синхропоследовательности 0x47 в любой позиции 8-байтного блока
- Извлечение пакетов размером 188 байт
- Проверка CRC для валидации пакетов
- Буферизация для обработки пакетов, пересекающих границы блоков

#### 2. timestamp_extractor
**Функция**: Извлечение и декодирование временных меток из пакетов T2-MI

**Ключевые особенности**:
- Фильтрация пакетов типа 0x20 (timestamp packets)
- Декодирование 40-битных секунд и 32-битных долей секунды
- Проверка валидности временных меток
- Преобразование в локальный формат времени

#### 3. enhanced_dpll
**Функция**: Цифровая петля фазовой автоподстройки для синхронизации локального времени

**Ключевые особенности**:
- Адаптивный ПИД-регулятор с автоматической настройкой коэффициентов
- Детектор захвата с многоуровневой индикацией
- Подавление джиттера и фазового шума
- Поддержка быстрого захвата и точного удержания

#### 4. kalman_filter
**Функция**: Оптимальная фильтрация и предсказание временных параметров

**Ключевые особенности**:
- Модель состояния включает время, частоту и дрейф частоты
- Адаптивная настройка ковариационных матриц
- Обработка выбросов и аномальных измерений
- Предсказание времени при потере входного сигнала

#### 5. enhanced_pps_generator
**Функция**: Генерация высокоточного PPS сигнала

**Ключевые особенности**:
- Формирование импульсов с точностью ±1 такт системной частоты
- Программируемая длительность и полярность импульса
- Компенсация задержек выходных буферов
- Генерация резервного PPS от альтернативных источников

#### 6. gnss_interface
**Функция**: Интерфейс с GNSS приемником для внешней синхронизации

**Ключевые особенности**:
- UART интерфейс с автоопределением скорости
- Парсинг NMEA сообщений (RMC, GGA, ZDA)
- Синхронизация с внешним PPS от GNSS
- Определение качества GNSS сигнала

#### 7. sit5503_controller
**Функция**: Управление прецизионным генератором SiT5503

**Ключевые особенности**:
- I2C интерфейс для конфигурации и управления
- Точная подстройка частоты с разрешением 0.1 ppb
- Мониторинг состояния и температуры
- Компенсация температурного дрейфа

#### 8. stm32_interface
**Функция**: Интерфейс с внешним микроконтроллером STM32

**Ключевые особенности**:
- SPI slave интерфейс с DMA-подобной передачей
- Обработка команд конфигурации и управления
- Передача статусной информации и телеметрии
- Генерация прерываний при критических событиях

#### 9. delay_compensation
**Функция**: Компенсация системных и сетевых задержек

**Ключевые особенности**:
- Автоматическое измерение задержек в системе
- Компенсация задержек распространения сигналов
- Учет температурных изменений задержек
- Калибровка по эталонным источникам

#### 10. edge_case_handler
**Функция**: Обработка нештатных ситуаций и восстановление

**Ключевые особенности**:
- Детектирование аномалий во входных данных
- Автоматическое восстановление после сбоев
- Переключение на резервные источники
- Генерация автономного PPS при потере всех источников

## Интерфейсы и протоколы

### T2-MI интерфейс

**Сигналы**:
- `t2mi_clk` (27 MHz) - тактовая частота T2-MI
- `t2mi_valid` - валидность данных
- `t2mi_data[63:0]` - 8 байт данных
- `t2mi_byte_enable[7:0]` - маска активных байт
- `t2mi_sync` - сигнал синхронизации кадра

**Протокол**:
- Данные передаются блоками по 8 байт
- Валидные байты указываются маской byte_enable
- Синхропоследовательность 0x47 может находиться в любой позиции

### SiT5503 I2C интерфейс

**Сигналы**:
- `sit5503_sda` - двунаправленная линия данных
- `sit5503_scl` - линия тактирования (400 кГц)

**Регистры**:
- 0x00-0x0F: Конфигурация частоты
- 0x10-0x1F: Статус и диагностика
- 0x20-0x2F: Температурная компенсация

### STM32 SPI интерфейс

**Сигналы**:
- `stm32_sclk` - тактовая частота SPI (до 10 МГц)
- `stm32_mosi` - данные от STM32
- `stm32_miso` - данные к STM32
- `stm32_cs_n` - выбор устройства
- `stm32_irq_n` - прерывание к STM32

**Формат команд**:
```
[CMD:8][ADDR:16][LEN:8][DATA:N*8]
```

### GNSS UART интерфейс

**Параметры**:
- Скорость: 9600-115200 бод (автоопределение)
- Формат: 8N1
- Протокол: NMEA 0183

**Поддерживаемые сообщения**:
- $GPRMC - время и дата
- $GPGGA - позиция и качество
- $GPZDA - время и дата с временной зоной

## Алгоритмы обработки

### Алгоритм синхронизации DPLL

1. **Фаза захвата**:
   - Быстрая подстройка частоты (Kp=1.0, Ki=0.1)
   - Порог захвата: ошибка фазы < 1 мс
   - Время захвата: < 10 секунд

2. **Фаза удержания**:
   - Точная подстройка (Kp=0.1, Ki=0.01)
   - Порог удержания: ошибка фазы < 100 нс
   - Стабильность: < 10 ppb

3. **Обработка потери сигнала**:
   - Переход в режим holdover
   - Использование предсказания Калмана
   - Постепенное увеличение неопределенности

### Алгоритм фильтра Калмана

**Модель состояния**:
```
x(k+1) = F * x(k) + w(k)
y(k) = H * x(k) + v(k)
```

где:
- x = [время, частота, дрейф]
- F - матрица перехода состояния
- H - матрица наблюдения
- w - шум процесса
- v - шум измерения

**Параметры**:
- Q (шум процесса): диагональ [1e-12, 1e-15, 1e-18]
- R (шум измерения): 1e-9
- P0 (начальная ковариация): диагональ [1e-6, 1e-9, 1e-12]

### Алгоритм компенсации задержек

1. **Измерение задержек**:
   - Loopback тестирование при инициализации
   - Корреляция с эталонными источниками
   - Статистическая обработка измерений

2. **Расчет компенсации**:
   - Учет постоянных задержек (кабели, буферы)
   - Учет переменных задержек (температура)
   - Применение калибровочных коэффициентов

3. **Применение компенсации**:
   - Сдвиг фазы генератора PPS
   - Корректировка временных меток
   - Обновление параметров DPLL

## Синхронизация и тактирование

### Тактовые домены

1. **Системный домен (100 МГц)**:
   - Основная логика обработки
   - DPLL и фильтр Калмана
   - Генератор PPS

2. **T2-MI домен (27 МГц)**:
   - Парсер T2-MI пакетов
   - Буферы входных данных

3. **SiT5503 домен (10 МГц)**:
   - Опорная частота для DPLL
   - Счетчики времени

4. **Низкоскоростные домены**:
   - UART (переменная частота)
   - I2C (400 кГц)
   - SPI (до 10 МГц)

### Синхронизация между доменами

- **Двухступенчатые синхронизаторы** для одиночных сигналов
- **Асинхронные FIFO** для передачи данных
- **Handshake протоколы** для управляющих сигналов
- **Gray кодирование** для многоразрядных счетчиков

### Сброс системы

1. **Асинхронный сброс** с синхронным снятием
2. **Последовательный сброс** модулей
3. **Автоматическая инициализация** после сброса
4. **Сохранение критических параметров** при кратковременных сбоях

## Управление состоянием

### Основные состояния системы

```
INIT -> SEARCH -> LOCK -> TRACK -> HOLDOVER
  ^                 |        |          |
  |                 v        v          |
  +<---- ERROR <----+--------+----------+
```

1. **INIT**: Инициализация и самотестирование
2. **SEARCH**: Поиск валидных временных меток
3. **LOCK**: Захват синхронизации
4. **TRACK**: Отслеживание и поддержание синхронизации
5. **HOLDOVER**: Автономная работа при потере сигнала
6. **ERROR**: Обработка критических ошибок

### Переходы между состояниями

- **INIT → SEARCH**: После успешной инициализации
- **SEARCH → LOCK**: При обнаружении валидных меток
- **LOCK → TRACK**: При достижении порога синхронизации
- **TRACK → HOLDOVER**: При потере входного сигнала
- **ANY → ERROR**: При критической ошибке
- **ERROR → INIT**: После восстановления

### Приоритеты источников синхронизации

1. **GNSS PPS** (если доступен и валиден)
2. **T2-MI timestamps** (основной источник)
3. **SiT5503 + Kalman** (режим holdover)
4. **Free-running** (аварийный режим)

## Производительность и оптимизация

### Ключевые метрики

- **Точность PPS**: ±10 нс относительно UTC
- **Стабильность**: < 10 ppb (parts per billion)
- **Время захвата**: < 10 секунд
- **Задержка обработки**: < 1 мкс
- **Использование ресурсов**: ~60% LUT, ~40% BRAM

### Оптимизации

1. **Параллельная обработка**:
   - 8-байтный парсер T2-MI
   - Конвейерная обработка в DPLL
   - Параллельные вычисления в фильтре Калмана

2. **Оптимизация памяти**:
   - Кольцевые буферы для потоковых данных
   - Разделяемая память между модулями
   - Эффективное использование BRAM

3. **Оптимизация тактовой частоты**:
   - Балансировка критических путей
   - Регистровая развязка длинных путей
   - Использование выделенных ресурсов FPGA

4. **Энергоэффективность**:
   - Clock gating для неактивных модулей
   - Динамическое управление частотой
   - Оптимизация переключений сигналов

### Масштабирование

- **Горизонтальное**: Поддержка нескольких потоков T2-MI
- **Вертикальное**: Увеличение точности и функциональности
- **Модульное**: Добавление новых источников синхронизации

## Диагностика и отладка

### Встроенные средства диагностики

1. **Счетчики производительности**:
   - Количество обработанных пакетов
   - Статистика ошибок CRC
   - Время в каждом состоянии

2. **Регистры состояния**:
   - Текущее состояние всех модулей
   - Флаги ошибок и предупреждений
   - Параметры синхронизации

3. **Трассировка событий**:
   - Кольцевой буфер критических событий
   - Временные метки событий
   - Контекстная информация

### Интерфейсы отладки

- **UART монитор**: Текстовый вывод состояния
- **SPI командный интерфейс**: Чтение/запись регистров
- **LED индикация**: Визуальная индикация состояния
- **Тестовые точки**: Доступ к внутренним сигналам

## Заключение

Архитектура T2MI PPS Generator v3 обеспечивает высокую точность, надежность и гибкость системы синхронизации времени. Модульная структура позволяет легко адаптировать систему под различные требования и добавлять новую функциональность. Использование современных алгоритмов обработки сигналов и оптимизация под целевую FPGA обеспечивают высокую производительность при умеренном использовании ресурсов.