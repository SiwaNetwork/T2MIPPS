# T2MI PPS Generator v3 - Техническая документация

## Обзор системы

T2MI PPS Generator v3 представляет собой значительно улучшенную версию системы генерации высокоточного сигнала PPS (Pulse Per Second) из телевизионного потока T2MI. Новая версия включает передовые алгоритмы обработки сигналов, поддержку множественных источников синхронизации и расширенные возможности конфигурации.

## Основные улучшения версии 3

### 1. Улучшенная производительность и точность

#### 1.1 Фильтр Калмана
- **Модуль**: `kalman_filter.v`
- **Назначение**: Оптимальная фильтрация временных меток и предсказание
- **Характеристики**:
  - 64-битная арифметика с фиксированной точкой
  - Адаптивная настройка параметров шума
  - Автоматическое определение сходимости
  - Оценка частотного смещения

#### 1.2 Улучшенный DPLL
- **Модуль**: `enhanced_dpll.v`
- **Назначение**: Высокоточная фазовая синхронизация
- **Характеристики**:
  - PI-контроллер с настраиваемыми коэффициентами
  - Адаптивная полоса пропускания
  - Режим holdover при потере синхронизации
  - Поддержка 10 МГц опорной частоты от SiT5503

#### 1.3 Параллельный парсер
- **Модуль**: `parallel_t2mi_parser.v`
- **Назначение**: Высокоскоростная обработка T2MI потока
- **Характеристики**:
  - Обработка 8 байт за такт
  - Автоматическое выравнивание данных
  - Конвейерная архитектура
  - Увеличенная пропускная способность до 800 Мбит/с

### 2. Расширенная функциональность

#### 2.1 Интерфейс STM32
- **Модуль**: `stm32_interface.v`
- **Назначение**: Управление и мониторинг через микроконтроллер STM32F302C8T6
- **Протокол**: SPI slave, до 10 МГц
- **Функции**:
  - Чтение статуса системы
  - Настройка параметров DPLL и фильтра Калмана
  - Установка компенсации задержек
  - Управление GNSS модулем
  - Прерывания по событиям

#### 2.2 Поддержка GPS/GLONASS
- **Модуль**: `gnss_interface.v`
- **Назначение**: Резервный источник синхронизации
- **Протокол**: NMEA 0183 через UART
- **Функции**:
  - Парсинг GPRMC и GPGGA сообщений
  - Извлечение времени UTC
  - Определение координат
  - Мониторинг качества сигнала

### 3. Компенсация задержек

#### 3.1 Модуль компенсации
- **Модуль**: `delay_compensation.v`
- **Назначение**: Точная компенсация задержек распространения
- **Возможности**:
  - Компенсация задержки в кабелях (0-1000 мкс)
  - Компенсация задержки в антенне (0-1000 мкс)
  - Температурная компенсация (настраиваемый коэффициент)
  - Точность компенсации: 1 нс

## Архитектура системы

```
┌─────────────────┐     ┌──────────────┐     ┌─────────────┐
│  T2MI Stream    │────▶│   Parallel   │────▶│  Timestamp  │
│  (8 bytes/clk)  │     │   Parser     │     │  Extractor  │
└─────────────────┘     └──────────────┘     └─────────────┘
                                                     │
                                                     ▼
┌─────────────────┐     ┌──────────────┐     ┌─────────────┐
│     STM32       │◀───▶│   Control    │◀───▶│   Kalman    │
│   Interface     │     │   Logic      │     │   Filter    │
└─────────────────┘     └──────────────┘     └─────────────┘
                                                     │
┌─────────────────┐            │                    ▼
│  GPS/GLONASS    │────────────┼──────────▶┌─────────────┐
│   Receiver      │            │            │  Enhanced   │
└─────────────────┘            │            │    DPLL     │
                               │            └─────────────┘
┌─────────────────┐            │                    │
│    SiT5503      │────────────┘                    ▼
│  10MHz OCXO     │                          ┌─────────────┐
└─────────────────┘                          │    Delay    │
                                             │Compensation │
                                             └─────────────┘
                                                     │
                                                     ▼
                                             ┌─────────────┐
                                             │  PPS Output │
                                             │   ±1 ns     │
                                             └─────────────┘
```

## Интерфейс STM32

### SPI протокол

Система использует SPI slave интерфейс для связи с STM32:
- **Скорость**: до 10 МГц
- **Режим**: CPOL=0, CPHA=0
- **Формат команды**: 16 бит команда + 32 бит данные

### Формат команды

```
[15]    - R/W бит (0=запись, 1=чтение)
[14:12] - Тип команды
[11:0]  - Адрес/параметр
```

### Типы команд

| Код | Тип | Описание |
|-----|-----|----------|
| 000 | Регистры | Доступ к внутренним регистрам |
| 001 | Статус | Чтение статуса системы |
| 010 | Конфигурация | Запись конфигурации |
| 011 | Задержки | Настройка компенсации задержек |
| 100 | GNSS | Управление GNSS модулем |
| 101 | DPLL | Параметры DPLL |
| 110 | Калман | Параметры фильтра Калмана |
| 111 | Система | Системные команды |

### Регистры статуса

| Адрес | Название | Описание |
|-------|----------|----------|
| 0x000 | STATUS | Общий статус системы |
| 0x001 | TIME_SEC_L | Младшие 32 бита секунд |
| 0x002 | TIME_SEC_H | Старшие 8 бит секунд |
| 0x003 | TIME_SUBSEC | Доли секунды |
| 0x004 | PHASE_ERROR | Фазовая ошибка DPLL |
| 0x005 | FREQ_ERROR | Частотная ошибка |
| 0x006 | ERROR_COUNT | Счетчик ошибок |
| 0x007 | PPS_COUNT | Счетчик PPS импульсов |

### Конфигурационные параметры

| Параметр | Диапазон | По умолчанию | Описание |
|----------|----------|--------------|----------|
| cable_delay_ns | 0-1000000 | 0 | Задержка в кабеле (нс) |
| antenna_delay_ns | 0-1000000 | 0 | Задержка в антенне (нс) |
| dpll_kp | 0-65535 | 100 | Пропорциональный коэффициент |
| dpll_ki | 0-65535 | 10 | Интегральный коэффициент |
| kalman_q | 0-2^32 | 1000 | Шум процесса |
| kalman_r | 0-2^32 | 10000 | Шум измерения |

## GNSS интерфейс

### Поддерживаемые протоколы
- NMEA 0183 v3.0
- Скорость: 115200 бод
- Формат: 8N1

### Обрабатываемые сообщения
- **GPRMC**: время и дата UTC
- **GPGGA**: координаты и качество сигнала
- **GLRMC**: GLONASS время (при поддержке)

### Режимы работы
- **GPS only**: только GPS спутники
- **GLONASS only**: только GLONASS спутники  
- **GPS+GLONASS**: комбинированный режим

## Алгоритмы обработки

### Фильтр Калмана

Используется двумерный фильтр Калмана со следующим вектором состояния:
- x[0] - временная метка
- x[1] - частотное смещение

Модель системы:
```
x(k+1) = F * x(k) + w(k)
z(k) = H * x(k) + v(k)

где:
F = [1, dt; 0, 1] - матрица перехода
H = [1, 0] - матрица наблюдения
w ~ N(0, Q) - шум процесса
v ~ N(0, R) - шум измерения
```

### DPLL алгоритм

PI-контроллер с адаптивной полосой:
```
e(k) = ref_phase - local_phase
u(k) = Kp * e(k) + Ki * Σe(i)
f_out = f_nom + u(k)
```

Адаптация полосы пропускания:
- При малой дисперсии фазы - узкая полоса
- При большой дисперсии - широкая полоса

## Компенсация задержек

### Источники задержек
1. **Кабельная задержка**: ~5 нс/м для коаксиального кабеля
2. **Антенная задержка**: зависит от типа антенны
3. **Системная задержка**: обработка в приемнике
4. **Температурная задержка**: ~50 пс/°C

### Формула компенсации
```
Total_delay = Cable_delay + Antenna_delay + System_delay + Temp_compensation
Temp_compensation = (T - 25°C) * Temp_coefficient
```

## Производительность

### Ключевые метрики

| Параметр | Значение |
|----------|----------|
| Точность PPS | ±1 нс |
| Стабильность (Allan deviation) | 1×10^-11 @ 1s |
| Время захвата | <10 секунд |
| Holdover стабильность | ±1 мкс/час |
| Максимальная скорость потока | 800 Мбит/с |
| Задержка обработки | <1 мкс |

### Использование ресурсов FPGA

| Ресурс | Использовано | Доступно | % |
|--------|--------------|----------|---|
| LUT | 18,500 | 24,000 | 77% |
| Регистры | 12,000 | 24,000 | 50% |
| BRAM | 480 Кбит | 1,032 Кбит | 46% |
| DSP | 8 | 56 | 14% |

## Диагностика

### LED индикаторы

| LED | Цвет | Значение |
|-----|------|----------|
| POWER | Зеленый | Питание включено |
| SYNC | Желтый | T2MI синхронизация |
| PPS | Красный | PPS активность |
| ERROR | Красный | Наличие ошибок |
| GNSS | Зеленый | GNSS синхронизация |
| STM32 | Синий | Активность связи |

### Отладочные выходы

Регистр debug_status содержит:
- [7] - Компенсация активна
- [6] - GNSS время валидно
- [5] - Фильтр Калмана сошелся
- [4] - DPLL в holdover
- [3] - DPLL заблокирован
- [2] - T2MI синхронизирован
- [1:0] - Источник времени

## Примеры использования

### Инициализация через STM32

```c
// Включение фильтра Калмана
spi_write_cmd(0x6000, 0x00000001);  // Enable Kalman
spi_write_cmd(0x6001, 0x000003E8);  // Q = 1000
spi_write_cmd(0x6002, 0x00002710);  // R = 10000

// Настройка DPLL
spi_write_cmd(0x5000, 0x00000064);  // Kp = 100
spi_write_cmd(0x5001, 0x0000000A);  // Ki = 10

// Установка компенсации задержек
spi_write_cmd(0x3000, 0x000001F4);  // Cable delay = 500ns
spi_write_cmd(0x3001, 0x00000064);  // Antenna delay = 100ns
```

### Чтение статуса

```c
uint32_t status = spi_read_cmd(0x8000);
if (status & 0x01) {
    // Система готова
    uint32_t time_sec = spi_read_cmd(0x8002);
    uint32_t time_subsec = spi_read_cmd(0x8003);
}
```

## Заключение

T2MI PPS Generator v3 представляет собой профессиональное решение для генерации высокоточного сигнала PPS с улучшенными характеристиками:
- Точность ±1 нс благодаря фильтру Калмана и улучшенному DPLL
- Поддержка множественных источников синхронизации
- Гибкая конфигурация через STM32
- Компенсация всех типов задержек
- Высокая надежность с резервированием

Система готова для применения в критически важных приложениях синхронизации времени.