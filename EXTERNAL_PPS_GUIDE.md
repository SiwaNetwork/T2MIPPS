# Руководство по использованию внешнего PPS эталона

## Обзор

В системе T2MI PPS Generator v3 реализована поддержка внешнего PPS (Pulse Per Second) эталона. Эта функциональность позволяет использовать высокоточный внешний источник временной синхронизации в качестве опорного сигнала для генерации выходного PPS.

## Возможности

- **Автоматический выбор источника**: Система может автоматически выбирать лучший доступный источник PPS на основе качества сигнала
- **Ручной выбор источника**: Возможность принудительного выбора конкретного источника через интерфейс STM32
- **Мониторинг качества**: Непрерывная оценка качества каждого источника PPS
- **Безударное переключение**: Плавное переключение между источниками без потери синхронизации
- **Режим holdover**: Автономная работа при потере всех источников синхронизации

## Поддерживаемые источники PPS

1. **T2MI** - PPS, извлеченный из потока T2MI (по умолчанию)
2. **GNSS** - PPS от приемника GNSS (GPS/GLONASS)
3. **External** - Внешний PPS эталон

## Технические характеристики

### Входной сигнал внешнего PPS
- **Уровень**: TTL/CMOS 3.3V
- **Полярность**: Положительный импульс
- **Длительность импульса**: 10 мкс - 500 мс
- **Фронт**: < 10 нс
- **Точность**: ±100 нс относительно UTC

### Измеряемые параметры
- **Частотная ошибка**: ±1 ppb разрешение
- **Фазовая ошибка**: ±10 нс разрешение
- **RMS джиттер**: Измерение за 1000 импульсов
- **Период сигнала**: С точностью 10 нс

## Подключение

### Физическое подключение
Внешний PPS подключается к выводу `ext_pps_in` FPGA:
- Вывод FPGA: Согласно файлу ограничений проекта
- Рекомендуется использовать коаксиальный кабель 50 Ом
- Терминирование на входе FPGA

### Электрическая схема
```
Внешний PPS источник
        |
        ├─── R1 (50 Ом) ─── GND (терминирование)
        |
        └─── C1 (100 пФ) ─── FPGA ext_pps_in
```

## Конфигурация через STM32

### Регистры управления

#### Регистр выбора источника PPS (адрес 0x1C0)
- Биты [1:0]: Выбор источника
  - 00: T2MI
  - 01: GNSS
  - 10: External PPS
  - 11: Зарезервировано

#### Регистр режима выбора (адрес 0x1C1)
- Бит 0: Включение автоматического выбора
  - 0: Ручной выбор
  - 1: Автоматический выбор (по умолчанию)

### Пример кода для STM32

```c
// Включение автоматического выбора источника
void enable_auto_pps_selection(void) {
    spi_write_register(0x1C1, 0x00000001);
}

// Принудительный выбор внешнего PPS
void select_external_pps(void) {
    spi_write_register(0x1C1, 0x00000000);  // Отключить автовыбор
    spi_write_register(0x1C0, 0x00000002);  // Выбрать External PPS
}

// Чтение текущего активного источника
uint32_t get_active_pps_source(void) {
    uint32_t status = spi_read_register(0x000);  // Читать статус
    return (status >> 2) & 0x03;  // Биты [3:2] - активный источник
}
```

## Индикация состояния

### Светодиоды
- **LED_EXT_PPS**: Горит при наличии и синхронизации внешнего PPS
- **LED_ERROR**: Мигает при переключении источников (failover)
- **LED_PPS**: Мигает синхронно с выходным PPS

### Выходные сигналы
- `ext_pps_locked`: Высокий уровень при синхронизации с внешним PPS
- `ext_pps_quality`: 16-битное значение качества (0-65535)

## Алгоритм работы

### Автоматический выбор источника

1. **Мониторинг доступности**: Система непрерывно проверяет наличие импульсов от каждого источника
2. **Оценка качества**: Для каждого источника вычисляется метрика качества на основе:
   - Стабильности частоты
   - Фазовой ошибки
   - Уровня джиттера
3. **Выбор лучшего**: Выбирается источник с наивысшим качеством
4. **Гистерезис**: Переключение происходит только при существенной разнице в качестве

### Обработка внешнего PPS

1. **Детектирование**: Обнаружение фронта входного сигнала
2. **Измерение периода**: Вычисление периода между импульсами
3. **Синхронизация фазы**: Выравнивание с внутренней временной базой
4. **Фильтрация**: Подавление джиттера и шумов
5. **Валидация**: Проверка соответствия критериям качества

## Критерии качества

### Для перехода в состояние "Locked"
- Частотная ошибка < 100 ppb
- Фазовая ошибка < 100 нс
- RMS джиттер < 1 мкс
- Минимум 10 последовательных хороших импульсов

### Для выхода из состояния "Locked"
- Потеря сигнала > 2 секунд
- Частотная ошибка > 1000 ppb
- Фазовая ошибка > 1 мкс
- 50 последовательных плохих импульсов

## Режим Holdover

При потере всех источников синхронизации система переходит в режим holdover:
- Продолжает генерировать PPS на основе последней известной частоты
- Точность деградирует со временем в зависимости от стабильности локального осциллятора
- Автоматический возврат к синхронизации при восстановлении источника

## Рекомендации по применению

### Для максимальной точности
1. Используйте короткие кабели (< 10 м)
2. Обеспечьте стабильное питание внешнего источника
3. Минимизируйте электромагнитные помехи
4. Используйте температурную компенсацию

### Типичные источники внешнего PPS
- Рубидиевые стандарты частоты
- Цезиевые атомные часы
- GPS дисциплинированные осцилляторы (GPSDO)
- Синхронизированные от сети PTP grandmaster часы

## Диагностика

### Проблема: Внешний PPS не детектируется
- Проверьте физическое подключение
- Измерьте уровень сигнала осциллографом
- Убедитесь в правильной полярности

### Проблема: Большая фазовая ошибка
- Компенсируйте задержку кабеля через регистры STM32
- Проверьте источник на соответствие спецификации
- Убедитесь в отсутствии отражений в линии

### Проблема: Нестабильное переключение источников
- Увеличьте порог качества (QUALITY_THRESHOLD)
- Проверьте стабильность всех источников
- Отключите автовыбор и используйте ручное управление

## Заключение

Поддержка внешнего PPS эталона значительно расширяет возможности системы T2MI PPS Generator, позволяя достичь точности синхронизации на уровне лучших мировых стандартов. При правильной настройке и качественном внешнем источнике система способна обеспечить долговременную стабильность лучше 1×10⁻¹² и точность синхронизации ±10 нс.