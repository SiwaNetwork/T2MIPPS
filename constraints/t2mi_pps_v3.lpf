# =============================================================================
# T2MI PPS Generator v3 - Pin Constraints File
# Target: Lattice LFE5U-25F-6BG256C
# =============================================================================

# Clock and Reset
LOCATE COMP "clk_100mhz" SITE "A7";
IOBUF PORT "clk_100mhz" IO_TYPE=LVCMOS33;
FREQUENCY PORT "clk_100mhz" 100.0 MHz;

LOCATE COMP "rst_n" SITE "B4";
IOBUF PORT "rst_n" IO_TYPE=LVCMOS33 PULLMODE=UP;

# T2MI Interface - Parallel 8-byte input
LOCATE COMP "t2mi_clk" SITE "C5";
IOBUF PORT "t2mi_clk" IO_TYPE=LVCMOS33;
FREQUENCY PORT "t2mi_clk" 27.0 MHz;

LOCATE COMP "t2mi_valid" SITE "D5";
IOBUF PORT "t2mi_valid" IO_TYPE=LVCMOS33;

# T2MI Data bus (64 bits)
LOCATE COMP "t2mi_data[0]" SITE "R1";
LOCATE COMP "t2mi_data[1]" SITE "P1";
LOCATE COMP "t2mi_data[2]" SITE "N1";
LOCATE COMP "t2mi_data[3]" SITE "M1";
LOCATE COMP "t2mi_data[4]" SITE "L1";
LOCATE COMP "t2mi_data[5]" SITE "K1";
LOCATE COMP "t2mi_data[6]" SITE "J1";
LOCATE COMP "t2mi_data[7]" SITE "H1";
LOCATE COMP "t2mi_data[8]" SITE "G1";
LOCATE COMP "t2mi_data[9]" SITE "F1";
LOCATE COMP "t2mi_data[10]" SITE "E2";
LOCATE COMP "t2mi_data[11]" SITE "D2";
LOCATE COMP "t2mi_data[12]" SITE "C2";
LOCATE COMP "t2mi_data[13]" SITE "B2";
LOCATE COMP "t2mi_data[14]" SITE "A2";
LOCATE COMP "t2mi_data[15]" SITE "R2";
LOCATE COMP "t2mi_data[16]" SITE "P2";
LOCATE COMP "t2mi_data[17]" SITE "N2";
LOCATE COMP "t2mi_data[18]" SITE "M2";
LOCATE COMP "t2mi_data[19]" SITE "L2";
LOCATE COMP "t2mi_data[20]" SITE "K2";
LOCATE COMP "t2mi_data[21]" SITE "J2";
LOCATE COMP "t2mi_data[22]" SITE "H2";
LOCATE COMP "t2mi_data[23]" SITE "G2";
LOCATE COMP "t2mi_data[24]" SITE "F3";
LOCATE COMP "t2mi_data[25]" SITE "E3";
LOCATE COMP "t2mi_data[26]" SITE "D3";
LOCATE COMP "t2mi_data[27]" SITE "C3";
LOCATE COMP "t2mi_data[28]" SITE "B3";
LOCATE COMP "t2mi_data[29]" SITE "A3";
LOCATE COMP "t2mi_data[30]" SITE "R3";
LOCATE COMP "t2mi_data[31]" SITE "P3";
LOCATE COMP "t2mi_data[32]" SITE "N3";
LOCATE COMP "t2mi_data[33]" SITE "M3";
LOCATE COMP "t2mi_data[34]" SITE "L3";
LOCATE COMP "t2mi_data[35]" SITE "K3";
LOCATE COMP "t2mi_data[36]" SITE "J3";
LOCATE COMP "t2mi_data[37]" SITE "H3";
LOCATE COMP "t2mi_data[38]" SITE "G3";
LOCATE COMP "t2mi_data[39]" SITE "F4";
LOCATE COMP "t2mi_data[40]" SITE "E4";
LOCATE COMP "t2mi_data[41]" SITE "D4";
LOCATE COMP "t2mi_data[42]" SITE "C4";
LOCATE COMP "t2mi_data[43]" SITE "B4";
LOCATE COMP "t2mi_data[44]" SITE "A4";
LOCATE COMP "t2mi_data[45]" SITE "R4";
LOCATE COMP "t2mi_data[46]" SITE "P4";
LOCATE COMP "t2mi_data[47]" SITE "N4";
LOCATE COMP "t2mi_data[48]" SITE "M4";
LOCATE COMP "t2mi_data[49]" SITE "L4";
LOCATE COMP "t2mi_data[50]" SITE "K4";
LOCATE COMP "t2mi_data[51]" SITE "J4";
LOCATE COMP "t2mi_data[52]" SITE "H4";
LOCATE COMP "t2mi_data[53]" SITE "G4";
LOCATE COMP "t2mi_data[54]" SITE "F5";
LOCATE COMP "t2mi_data[55]" SITE "E5";
LOCATE COMP "t2mi_data[56]" SITE "D6";
LOCATE COMP "t2mi_data[57]" SITE "C6";
LOCATE COMP "t2mi_data[58]" SITE "B6";
LOCATE COMP "t2mi_data[59]" SITE "A6";
LOCATE COMP "t2mi_data[60]" SITE "R5";
LOCATE COMP "t2mi_data[61]" SITE "P5";
LOCATE COMP "t2mi_data[62]" SITE "N5";
LOCATE COMP "t2mi_data[63]" SITE "M5";

IOBUF PORT "t2mi_data[*]" IO_TYPE=LVCMOS33;

# T2MI Byte enable
LOCATE COMP "t2mi_byte_enable[0]" SITE "L5";
LOCATE COMP "t2mi_byte_enable[1]" SITE "K5";
LOCATE COMP "t2mi_byte_enable[2]" SITE "J5";
LOCATE COMP "t2mi_byte_enable[3]" SITE "H5";
LOCATE COMP "t2mi_byte_enable[4]" SITE "G5";
LOCATE COMP "t2mi_byte_enable[5]" SITE "F6";
LOCATE COMP "t2mi_byte_enable[6]" SITE "E6";
LOCATE COMP "t2mi_byte_enable[7]" SITE "D7";

IOBUF PORT "t2mi_byte_enable[*]" IO_TYPE=LVCMOS33;

LOCATE COMP "t2mi_sync" SITE "B5";
IOBUF PORT "t2mi_sync" IO_TYPE=LVCMOS33;

# SiT5503 Interface
LOCATE COMP "sit5503_clk" SITE "F2";
IOBUF PORT "sit5503_clk" IO_TYPE=LVCMOS33;
FREQUENCY PORT "sit5503_clk" 10.0 MHz;

LOCATE COMP "sit5503_scl" SITE "H1";
IOBUF PORT "sit5503_scl" IO_TYPE=LVCMOS33 OPENDRAIN=ON;

LOCATE COMP "sit5503_sda" SITE "H2";
IOBUF PORT "sit5503_sda" IO_TYPE=LVCMOS33 OPENDRAIN=ON;

# STM32 SPI Interface
LOCATE COMP "stm32_sclk" SITE "T1";
IOBUF PORT "stm32_sclk" IO_TYPE=LVCMOS33;

LOCATE COMP "stm32_mosi" SITE "T2";
IOBUF PORT "stm32_mosi" IO_TYPE=LVCMOS33;

LOCATE COMP "stm32_miso" SITE "T3";
IOBUF PORT "stm32_miso" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "stm32_cs_n" SITE "T4";
IOBUF PORT "stm32_cs_n" IO_TYPE=LVCMOS33 PULLMODE=UP;

LOCATE COMP "stm32_irq_n" SITE "T5";
IOBUF PORT "stm32_irq_n" IO_TYPE=LVCMOS33 DRIVE=8;

# GNSS Interface
LOCATE COMP "gnss_rx" SITE "U1";
IOBUF PORT "gnss_rx" IO_TYPE=LVCMOS33;

LOCATE COMP "gnss_tx" SITE "U2";
IOBUF PORT "gnss_tx" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "gnss_pps_in" SITE "U3";
IOBUF PORT "gnss_pps_in" IO_TYPE=LVCMOS33;

# Temperature sensor input
LOCATE COMP "temperature[0]" SITE "V1";
LOCATE COMP "temperature[1]" SITE "V2";
LOCATE COMP "temperature[2]" SITE "V3";
LOCATE COMP "temperature[3]" SITE "V4";
LOCATE COMP "temperature[4]" SITE "V5";
LOCATE COMP "temperature[5]" SITE "W1";
LOCATE COMP "temperature[6]" SITE "W2";
LOCATE COMP "temperature[7]" SITE "W3";
LOCATE COMP "temperature[8]" SITE "W4";
LOCATE COMP "temperature[9]" SITE "W5";
LOCATE COMP "temperature[10]" SITE "Y1";
LOCATE COMP "temperature[11]" SITE "Y2";
LOCATE COMP "temperature[12]" SITE "Y3";
LOCATE COMP "temperature[13]" SITE "Y4";
LOCATE COMP "temperature[14]" SITE "Y5";
LOCATE COMP "temperature[15]" SITE "AA1";

IOBUF PORT "temperature[*]" IO_TYPE=LVCMOS33;

# Main outputs
LOCATE COMP "pps_out" SITE "E1";
IOBUF PORT "pps_out" IO_TYPE=LVCMOS33 DRIVE=12;

LOCATE COMP "pps_backup" SITE "F1";
IOBUF PORT "pps_backup" IO_TYPE=LVCMOS33 DRIVE=12;

# Time outputs (for monitoring)
LOCATE COMP "time_seconds[0]" SITE "AA2";
LOCATE COMP "time_seconds[1]" SITE "AA3";
LOCATE COMP "time_seconds[2]" SITE "AA4";
LOCATE COMP "time_seconds[3]" SITE "AA5";
LOCATE COMP "time_seconds[4]" SITE "AB1";
LOCATE COMP "time_seconds[5]" SITE "AB2";
LOCATE COMP "time_seconds[6]" SITE "AB3";
LOCATE COMP "time_seconds[7]" SITE "AB4";

IOBUF PORT "time_seconds[*]" IO_TYPE=LVCMOS33;

# Status outputs
LOCATE COMP "sync_locked" SITE "AC1";
IOBUF PORT "sync_locked" IO_TYPE=LVCMOS33;

LOCATE COMP "dpll_locked" SITE "AC2";
IOBUF PORT "dpll_locked" IO_TYPE=LVCMOS33;

LOCATE COMP "kalman_converged" SITE "AC3";
IOBUF PORT "kalman_converged" IO_TYPE=LVCMOS33;

# Debug status bus
LOCATE COMP "debug_status[0]" SITE "B1";
LOCATE COMP "debug_status[1]" SITE "C1";
LOCATE COMP "debug_status[2]" SITE "D1";
LOCATE COMP "debug_status[3]" SITE "E1";
LOCATE COMP "debug_status[4]" SITE "F1";
LOCATE COMP "debug_status[5]" SITE "G1";
LOCATE COMP "debug_status[6]" SITE "H1";
LOCATE COMP "debug_status[7]" SITE "J1";

IOBUF PORT "debug_status[*]" IO_TYPE=LVCMOS33;

# LED outputs
LOCATE COMP "led_power" SITE "K2";
IOBUF PORT "led_power" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "led_sync" SITE "J2";
IOBUF PORT "led_sync" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "led_pps" SITE "B6";
IOBUF PORT "led_pps" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "led_error" SITE "G2";
IOBUF PORT "led_error" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "led_gnss" SITE "AD1";
IOBUF PORT "led_gnss" IO_TYPE=LVCMOS33 DRIVE=8;

LOCATE COMP "led_stm32" SITE "AD2";
IOBUF PORT "led_stm32" IO_TYPE=LVCMOS33 DRIVE=8;

# Timing Constraints
BLOCK ASYNCPATHS;
BLOCK RESETPATHS;

# Clock domain crossing constraints
MULTICYCLE PATH FROM CLKNET "t2mi_clk_c" TO CLKNET "clk_100mhz_c" 2 X;
MULTICYCLE PATH FROM CLKNET "sit5503_clk_c" TO CLKNET "clk_100mhz_c" 2 X;
MULTICYCLE PATH FROM CLKNET "stm32_sclk_c" TO CLKNET "clk_100mhz_c" 2 X;

# PPS output timing constraint - critical path
MAXDELAY FROM PORT "clk_100mhz" TO PORT "pps_out" 5.0 ns;
MAXDELAY FROM PORT "clk_100mhz" TO PORT "pps_backup" 5.0 ns;

# I2C timing
MAXDELAY FROM PORT "sit5503_sda" TO PORT "sit5503_scl" 10.0 ns;
MAXDELAY FROM PORT "sit5503_scl" TO PORT "sit5503_sda" 10.0 ns;