# T2MI PPS Generator с поддержкой SiT5503


**Целевая FPGA**: Lattice LFE5U-25F-6BG256C

### Новые возможности версии 2.0

Проект T2MI PPS Generator был значительно расширен для поддержки высокостабильного генератора SiT5503 с I2C управлением. Это обеспечивает:

- **Высокостабильное формирование PPS** с точностью ±5 ppb
- **Автономную работу** при пропадании T2-MI сигнала
- **Автоматическую калибровку** частоты генератора
- **Программируемую подстройку** через I2C интерфейс
- **Резервированный выход PPS** для критических применений

## Архитектура системы

### Основные компоненты

1. **T2-MI Packet Parser** - извлечение пакетов из потока
2. **Timestamp Extractor** - извлечение временных штампов
3. **I2C Master Controller** - управление SiT5503
4. **SiT5503 Controller** - высокоуровневое управление генератором
5. **Enhanced PPS Generator** - формирование высокоточного PPS
6. **Clock Management** - управление тактовыми сигналами

### Блок-схема системы

```
T2-MI Stream ──► Packet Parser ──► Timestamp Extractor
                                          │
                                          ▼
SiT5503 ◄──── I2C Controller ◄──── Enhanced PPS Generator
  │                                       │
  ▼                                       ▼
10 MHz ──────────────────────────► PPS Output (Main)
                                          │
                                          ▼
                                   PPS Backup Output
```

## Технические характеристики

### Точность и стабильность

- **Базовая точность**: ±5 ppb (SiT5503)
- **Точность PPS**: ±10 нс при синхронизации с T2-MI
- **Автономная точность**: ±50 нс без T2-MI сигнала
- **Время установления**: < 100 мс после включения
- **Диапазон подстройки**: ±25 ppm (программируемый)

### Интерфейсы

#### T2-MI вход
- **Формат**: DVB-T2 Modulator Interface
- **Скорость**: До 270 Мбит/с
- **Поддерживаемые пакеты**: Тип 0x20 (временные штампы)

#### SiT5503 интерфейс
- **Частота**: 10 МГц ±25 ppm
- **I2C адрес**: 0x68 (по умолчанию)
- **Скорость I2C**: 100 кГц (стандартный режим)
- **Напряжение**: 3.3В

#### Выходы PPS
- **Основной выход**: Высокоточный PPS
- **Резервный выход**: Дублирующий PPS
- **Длительность импульса**: 10 мкс
- **Уровни**: LVCMOS 3.3В

## Режимы работы

### 1. Синхронизированный режим

В этом режиме система синхронизирована с T2-MI потоком:

- PPS формируется на основе временных штампов T2-MI
- SiT5503 используется как высокостабильная опорная частота
- Автоматическая калибровка каждый час
- Точность ±10 нс

### 2. Автономный режим

Активируется при пропадании T2-MI сигнала:

- PPS формируется только от SiT5503
- Сохранение последней калибровки
- Постепенная деградация точности
- Точность ±50 нс в течение 24 часов

### 3. Режим калибровки

Периодическая подстройка SiT5503:

- Измерение отклонения частоты
- Расчет коррекции через I2C
- Обновление параметров генератора
- Сохранение истории калибровок

## Назначение выводов FPGA

### Системные сигналы
- **A7**: clk_100mhz - Системная частота 100 МГц
- **B4**: rst_n - Сброс (активный низкий)

### T2-MI интерфейс
- **R1-B5**: t2mi_data[7:0] - Данные T2-MI
- **G1**: t2mi_valid - Валидность данных

### SiT5503 интерфейс
- **F2**: sit5503_clk - Вход 10 МГц от SiT5503
- **H1**: sit5503_scl - I2C тактовая линия
- **H2**: sit5503_sda - I2C линия данных

### Выходы PPS
- **E1**: pps_out - Основной выход PPS
- **F1**: pps_backup - Резервный выход PPS

### Индикация состояния
- **B6**: led_power - Индикатор питания
- **J2**: led_sync - Индикатор синхронизации
- **B6**: led_pps - Индикатор активности PPS
- **G2**: led_error - Индикатор ошибки
- **A2**: led_autonomous - Индикатор автономного режима
- **A3**: led_sit5503 - Индикатор состояния SiT5503

## Установка и настройка

### Требования к оборудованию

1. **FPGA плата** с Lattice LFE5U-25F-6BG256C
2. **SiT5503 генератор** в корпусе 7x5 мм
3. **Подтяжки I2C** 4.7 кОм на SCL/SDA
4. **Источник питания** 3.3В для SiT5503

### Подключение SiT5503

```
SiT5503 Pin | FPGA Pin | Функция
------------|----------|----------
1 (OE/NC)   | VCC      | Разрешение выхода
2 (GND)     | GND      | Земля
3 (CLK)     | F2       | Выход 10 МГц
4 (VDD)     | VCC      | Питание 3.3В
5 (SDA/NC)  | H2       | I2C данные
6 (A1/NC)   | GND      | Адрес A1
7 (A0/NC)   | GND      | Адрес A0
8 (SCL/NC)  | H1       | I2C тактовая
9 (GND)     | GND      | Земля
10 (VDD)    | VCC      | Питание 3.3В
```

### Программирование FPGA

1. Откройте проект `T2MI_PPS_Generator.ldf` в Diamond Lattice
2. Убедитесь, что все новые модули добавлены в проект
3. Запустите синтез: Process → Run All
4. Проверьте отчеты о тайминге
5. Загрузите битстрим в FPGA

## Диагностика и отладка

### Индикаторы состояния

#### LED индикаторы
- **led_power**: Постоянно горит при подаче питания
- **led_sync**: Горит при синхронизации с T2-MI
- **led_pps**: Мигает с частотой PPS
- **led_error**: Мигает при ошибках
- **led_autonomous**: Мигает в автономном режиме
- **led_sit5503**: Горит при готовности SiT5503

#### Регистр debug_status[7:0]
- **Бит 0**: Ошибка парсера T2-MI
- **Бит 1**: Ошибка извлечения временных штампов
- **Бит 2**: Готовность SiT5503
- **Бит 3**: Автономный режим
- **Бит 4**: Запрос калибровки
- **Бит 5**: Завершение калибровки
- **Бит 6**: Высокая ошибка времени
- **Бит 7**: Ошибка SiT5503

#### Регистр pps_status[7:0]
- **Бит 0**: Инициализация
- **Бит 1**: Ожидание синхронизации
- **Бит 2**: Синхронизирован
- **Бит 3**: Автономный режим
- **Бит 4**: Калибровка
- **Бит 5**: Использование SiT5503
- **Бит 6**: Время валидно
- **Бит 7**: Ошибка

### Типичные проблемы и решения

#### SiT5503 не готов
- Проверьте питание 3.3В
- Проверьте подключение I2C линий
- Убедитесь в наличии подтяжек 4.7 кОм

#### Нет синхронизации с T2-MI
- Проверьте входной сигнал T2-MI
- Убедитесь в правильности назначения пинов
- Проверьте наличие пакетов типа 0x20

#### Низкая точность PPS
- Проверьте стабильность SiT5503
- Запустите принудительную калибровку
- Проверьте температурные условия

## Калибровка и настройка

### Автоматическая калибровка

Система автоматически калибрует SiT5503 каждый час:

1. Измерение отклонения частоты относительно T2-MI
2. Расчет необходимой коррекции
3. Программирование SiT5503 через I2C
4. Верификация результата

### Ручная калибровка

Для принудительной калибровки:

1. Установите сигнал `calibrate_start`
2. Дождитесь завершения (`calibration_done`)
3. Проверьте регистр статуса

### Программирование частоты

Для изменения частоты SiT5503:

```verilog
// Установка смещения частоты
frequency_offset = 16'h0100;  // +256 единиц
offset_valid = 1'b1;
```

## Технические детали реализации

### I2C протокол

Контроллер I2C поддерживает:
- Стандартный режим (100 кГц)
- 7-битная адресация
- Операции чтения/записи
- Автоматическое управление START/STOP

### Тайминг PPS

Формирование PPS основано на:
- 32-битном счетчике субсекунд
- Точном инкременте для каждого такта
- Коррекции при синхронизации
- Компенсации дрейфа частоты

### Управление тактовыми доменами

Система использует несколько тактовых доменов:
- 100 МГц системная частота
- 10 МГц от SiT5503
- Асинхронный T2-MI поток

Синхронизация обеспечивается:
- Двухтактовыми синхронизаторами
- Метастабильность-устойчивыми схемами
- Контролем временных ограничений

## Заключение

Версия 2.0 проекта T2MI PPS Generator с поддержкой SiT5503 обеспечивает:

- **Высочайшую точность** формирования PPS
- **Надежность** при пропадании внешних сигналов
- **Гибкость** настройки и калибровки
- **Простоту** интеграции в существующие системы

Проект готов к использованию в критических приложениях, требующих высокоточной временной синхронизации.

