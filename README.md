# T2MI PPS Generator

Высокоточный генератор PPS (Pulse Per Second) сигнала из телевизионного потока T2MI (T2 Modulator Interface).

## Обзор проекта

Система генерирует высокоточный сигнал PPS из временных меток DVB-T2, передаваемых в потоке T2MI через спутниковую связь. Реализована на FPGA Lattice ECP5 с поддержкой внешней синхронизации и компенсации задержек.

### Основные характеристики

- **FPGA**: Lattice LFE5U-25F-6BG256C
- **Точность**: ±10 нс (базовая), ±5 ppb с SiT5503
- **Входной поток**: T2MI, 8 бит @ 27 МГц
- **Выходной сигнал**: PPS (1 Гц), TTL 3.3В
- **Интерфейсы**: UART, I2C, SPI, SNMP, Web

### Версия проекта

**Version 3 (t2mi_pps_top_v3)** - Полнофункциональная версия:
- Фильтр Калмана для оценки фазы/частоты
- Продвинутый DPLL с PID контроллером
- Allan deviation и MTIE мониторинг
- UART интерфейс мониторинга
- Система логирования
- Компенсация спутниковой задержки

### Ключевые возможности

- Параллельный парсинг T2MI пакетов
- Адаптивная DPLL с фильтром Калмана (v3)
- Поддержка внешних источников PPS (GNSS)
- Компенсация спутниковых задержек (v3)
- Веб-интерфейс для настройки и мониторинга
- SNMP агент для удаленного управления

## Быстрый старт

### 1. Требования

- Lattice Diamond 3.14+
- Python 3.7+ (для веб-интерфейса и SNMP)
- FPGA плата с LFE5U-25F-6BG256C
- Источник T2MI потока

### 2. Сборка проекта

```bash
# Клонирование репозитория
git clone https://github.com/your-org/t2mi-pps-generator.git
cd t2mi-pps-generator

# Сборка FPGA прошивки
make all

# Или через Lattice Diamond GUI:
# 1. File → Open → Project
# 2. Выберите T2MI_PPS_Generator.ldf
# 3. Process → Run All
```

### 3. Программирование FPGA

```bash
# JTAG программирование
pgrcmd -infile impl1/T2MI_PPS_Generator_impl1.xcf

# Или через Diamond Programmer GUI
```

### 4. Подключение сигналов

| Пин | Сигнал | Описание |
|-----|--------|----------|
| P3  | clk_100mhz | Системная тактовая 100 МГц |
| T1  | rst_n | Сброс (активный низкий) |
| P4  | t2mi_clk | Тактовая T2MI 27 МГц |
| R1-R4, T2-T4, P1-P2 | t2mi_data[7:0] | Данные T2MI |
| N1  | t2mi_valid | Строб данных T2MI |
| N2  | t2mi_sync | Синхронизация T2MI |
| M1  | pps_out | Выход PPS |
| M2  | pps_out_en | Разрешение PPS |
| K1  | uart_tx | UART передача |
| K2  | uart_rx | UART прием |
| H1  | i2c_scl | I2C тактовая (SiT5503) |
| H2  | i2c_sda | I2C данные (SiT5503) |

## Архитектура системы

### Структура модулей

```
t2mi_pps_top_v3 (верхний уровень)
├── t2mi_packet_parser      # Парсер T2MI пакетов
├── timestamp_extractor     # Извлечение временных меток
├── advanced_dpll_pid       # DPLL с PID контроллером
├── kalman_filter          # Фильтр Калмана
├── enhanced_pps_generator  # Генератор PPS
├── sit5503_controller     # Управление осциллятором
├── satellite_delay_comp   # Компенсация задержек
├── uart_monitor          # UART интерфейс
└── logging_system        # Система логирования
```

### Алгоритмы обработки

1. **Парсинг T2MI**: Параллельная обработка 8-битных данных, поиск пакетов типа 0x20
2. **Извлечение времени**: Декодирование 64-битных временных меток DVB-T2
3. **Синхронизация**: Адаптивная DPLL с фильтром Калмана для отслеживания фазы
4. **Генерация PPS**: Формирование импульсов с компенсацией задержек

## Конфигурация

### Веб-интерфейс

```bash
# Запуск веб-сервера
cd web_interface
pip install -r requirements.txt
python app.py

# Откройте в браузере: http://localhost:5000
```

### SNMP агент

```bash
# Запуск SNMP агента
cd snmp_agent
pip install -r requirements.txt
python snmp_agent.py

# Тестирование
snmpget -v2c -c public localhost 1.3.6.1.4.1.99999.1.1.0
```

### Компенсация спутниковой задержки

Типичные значения для геостационарных спутников:
- Односторонняя задержка: ~119-120 мс
- Вариация: ±1-2 мс

Настройка через веб-интерфейс или UART команду:
```
set_sat_delay 119500  # Установка задержки 119.5 мс
```

### Интеграция SiT5503

Для повышения точности подключите высокостабильный осциллятор SiT5503:

1. Подключите по I2C (адрес 0x68)
2. Используйте подтягивающие резисторы 4.7 кОм
3. Включите в конфигурации: `USE_SIT5503 = 1`

## Диагностика

### UART консоль

```bash
# Подключение к консоли
screen /dev/ttyUSB0 115200

# Основные команды
status          # Общий статус системы
pps_stats       # Статистика PPS
dpll_status     # Состояние DPLL
test_pps        # Тест генерации PPS
```

### Мониторинг через веб

- **Dashboard**: Реальное время статистики
- **Configuration**: Настройка параметров
- **Logs**: Просмотр системных логов
- **Diagnostics**: Расширенная диагностика

## Технические детали

### Точность синхронизации

| Версия | Точность | Стабильность | Условия |
|--------|----------|--------------|---------|
| v1.0 | ±100 нс | ±50 ppb | Базовая |
| v2.0 | ±10 нс | ±10 ppb | С фильтром Калмана |
| v3.0 | ±5 нс | ±5 ppb | С SiT5503 |

### Ресурсы FPGA

- LUT: ~8,500 (35%)
- Регистры: ~6,200 (26%)
- BRAM: 12 блоков
- DSP: 4 блока
- Частота: 100 МГц

### Форматы данных

**T2MI пакет типа 0x20:**
```
[0x47][0x00][0x20][0x00][timestamp_64bit][payload...]
```

**Временная метка DVB-T2:**
- 64 бита, счетчик 10 МГц
- Старшие 32 бита: секунды
- Младшие 32 бита: доли секунды

## Расширенные возможности

### Поддержка внешнего PPS

Система поддерживает три источника PPS:
1. **T2MI** - из потока (по умолчанию)
2. **GNSS** - от GPS/GLONASS приемника
3. **External** - внешний эталон

Автоматический выбор лучшего источника или ручное управление.

### Режим Holdover

При потере синхронизации система переходит в автономный режим:
- Экстраполяция частоты по истории
- Постепенная деградация точности
- Автоматическое восстановление

### Логирование и статистика

- Allan deviation для оценки стабильности
- MTIE для оценки точности
- Детальные логи всех событий
- Экспорт статистики через SNMP/Web

## Устранение неполадок

### Нет выходного PPS

1. Проверьте входной T2MI поток
2. Убедитесь в наличии пакетов 0x20
3. Проверьте статус DPLL блокировки
4. Включите debug режим: `debug_enable 1`

### Большая фазовая ошибка

1. Проверьте настройку компенсации задержки
2. Калибруйте систему: `calibrate_auto`
3. Увеличьте полосу DPLL: `dpll_bandwidth 2`

### Нестабильная синхронизация

1. Проверьте качество входного сигнала
2. Включите фильтр Калмана: `kalman_enable 1`
3. Настройте параметры фильтра

## Лицензия

Проект распространяется под лицензией MIT. См. файл LICENSE.

## Контакты и поддержка

- Email: support@example.com
- Issues: https://github.com/your-org/t2mi-pps-generator/issues
- Wiki: https://github.com/your-org/t2mi-pps-generator/wiki