# T2MI PPS Generator 

### Основные возможности

- **Парсинг T2-MI потока**: Автоматическое обнаружение и декодирование пакетов T2-MI
- **Извлечение временных штампов**: Обработка пакетов типа 0x20 с временными метками DVB-T2
- **Генерация PPS**: Формирование высокоточного сигнала 1 импульс в секунду
- **Синхронизация**: Автоматическая синхронизация с входящими временными штампами
- **Диагностика**: Встроенные средства мониторинга и отладки
- **Индикация состояния**: LED индикаторы для визуального контроля работы

## Архитектура системы

### Структура модулей

```
t2mi_pps_top (верхний уровень)
├── t2mi_packet_parser (парсер T2-MI пакетов)
├── timestamp_extractor (извлечение временных штампов)
├── pps_generator (генератор PPS)
└── sync_modules (модули синхронизации)
```

### Основные компоненты

1. **T2-MI Packet Parser** (`t2mi_packet_parser.v`)
   - Синхронизация с потоком T2-MI
   - Извлечение отдельных пакетов
   - Определение типа пакетов
   - Контроль целостности данных

2. **Timestamp Extractor** (`timestamp_extractor.v`)
   - Фильтрация пакетов типа 0x20
   - Декодирование структуры временных штампов
   - Извлечение секунд и долей секунды
   - Валидация данных

3. **PPS Generator** (`pps_generator.v`)
   - Отслеживание текущего времени
   - Синхронизация с входящими штампами
   - Генерация точных PPS импульсов
   - Контроль дрейфа и ошибок

4. **Sync Modules** (`sync_modules.v`)
   - Синхронизация тактовых доменов
   - Синхронизация сброса
   - Обработка метастабильности

## Технические характеристики

### Целевая FPGA
- **Модель**: Lattice LFE5U-25F-6BG256C
- **Семейство**: ECP5
- **Логические элементы**: 24,000 LUT
- **Встроенная память**: 1,032,192 бит
- **Количество I/O**: 197
- **Корпус**: CABGA-256

### Тактовые частоты
- **Системная частота**: 100 МГц
- **T2-MI частота**: 27 МГц 
- **PPS точность**: ±10 нс 

### Интерфейсы

#### Входные сигналы
- `clk_100mhz` - системная тактовая частота 100 МГц
- `rst_n` - сигнал сброса (активный низкий уровень)
- `t2mi_clk` - тактовая частота T2-MI потока
- `t2mi_valid` - сигнал валидности данных T2-MI
- `t2mi_data[7:0]` - байт данных T2-MI
- `t2mi_sync` - сигнал синхронизации T2-MI

#### Выходные сигналы
- `pps_out` - основной выход PPS (высокоточный)
- `timestamp_valid` - флаг валидности извлеченного штампа
- `sync_locked` - индикатор синхронизации с T2-MI
- `debug_status[7:0]` - регистр состояния для отладки
- `led_power` - индикатор питания
- `led_sync` - индикатор синхронизации
- `led_pps` - индикатор PPS импульсов
- `led_error` - индикатор ошибок

## Структура временного штампа DVB-T2

Согласно стандарту DVB-T2, временной штамп передается в пакетах типа 0x20 и имеет следующую структуру:

| Поле | Размер | Описание |
|------|--------|----------|
| rfu | 4 бита | Зарезервировано (должно быть 0) |
| bw | 4 бита | Код ширины канала |
| utco | 13 бит | Коррекция UTC (секунды) |
| seconds_since_2000 | 40 бит | Секунды с 1 января 2000 года |
| subseconds | 32 бита | Доля секунды (высокая точность) |

## Установка и использование

### Требования к системе
- Lattice Diamond 3.12 или новее
- ModelSim или Icarus Verilog (для симуляции)
- Make (для автоматизации сборки)

### Открытие проекта в Diamond Lattice

1. Запустите Lattice Diamond
2. Выберите "File" → "Open" → "Project"
3. Откройте файл `T2MI_PPS_Generator.ldf`
4. Проект автоматически загрузится со всеми исходными файлами

### Сборка проекта

#### Через Diamond Lattice GUI:
1. В Project Navigator выберите Implementation "impl1"
2. Запустите "Process" → "Run All" для полной сборки
3. Результирующий bitstream будет в папке `impl1/`

#### Через командную строку:
```bash
# Полная сборка
make all

# Только синтез
make synthesis

# Только трассировка
make place_route

# Генерация bitstream
make bitstream
```

### Симуляция

```bash
# С ModelSim
make simulate

# С Icarus Verilog
make sim_icarus
```

## Принцип работы

### Алгоритм обработки

1. **Инициализация**
   - Сброс всех модулей
   - Ожидание стабилизации тактовых сигналов

2. **Синхронизация с T2-MI**
   - Поиск синхробайта 0x47
   - Установление синхронизации потока
   - Переход в режим парсинга пакетов

3. **Парсинг пакетов**
   - Извлечение заголовка пакета
   - Определение типа и длины
   - Буферизация данных пакета

4. **Обработка временных штампов**
   - Фильтрация пакетов типа 0x20
   - Декодирование полей штампа
   - Валидация корректности данных

5. **Генерация PPS**
   - Отслеживание текущего времени
   - Синхронизация с входящими штампами
   - Генерация импульсов на границах секунд

### Обработка ошибок

Система включает несколько уровней контроля ошибок:

- **Синхронизация потока**: Контроль наличия синхробайтов
- **Валидация пакетов**: Проверка длины и структуры
- **Проверка штампов**: Валидация полей временных меток
- **Контроль дрейфа**: Мониторинг точности PPS

## Настройка и калибровка

### Параметры конфигурации

В файле `pps_generator.v` можно настроить следующие параметры:

```verilog
parameter CLK_FREQ_HZ = 100_000_000;    // Частота системной тактовой
parameter PPS_PULSE_WIDTH = 1000;       // Длительность PPS импульса (10 мкс)
parameter SYNC_THRESHOLD = 1000;        // Порог синхронизации
parameter MAX_DRIFT = 10000;            // Максимальный дрейф
```

### Калибровка точности

1. Подключите высокоточный частотомер к выходу PPS
2. Сравните с эталонным источником времени
3. При необходимости скорректируйте `subsec_increment`

## Диагностика и отладка

### Регистр состояния debug_status[7:0]

| Бит | Назначение |
|-----|------------|
| 7 | pps_error - ошибка генерации PPS |
| 6 | extractor_error - ошибка извлечения штампов |
| 5 | parser_error - ошибка парсинга пакетов |
| 4 | timestamp_ready - готовность штампа |
| 3 | timestamp_valid - валидность штампа |
| 2 | packet_valid - валидность пакета |
| 1 | sync_locked - синхронизация установлена |
| 0 | rst_n_sync - состояние сброса |

### Типичные проблемы и решения

**Проблема**: LED sync не загорается
- **Причина**: Отсутствие синхронизации T2-MI
- **Решение**: Проверьте подключение t2mi_clk и t2mi_sync

**Проблема**: LED error горит постоянно
- **Причина**: Ошибки в данных или конфигурации
- **Решение**: Проверьте debug_status для определения источника

**Проблема**: PPS не генерируется
- **Причина**: Отсутствие валидных временных штампов
- **Решение**: Убедитесь в наличии пакетов типа 0x20 в потоке

## Файловая структура проекта

```
t2mi_pps_project/
├── T2MI_PPS_Generator.ldf      # Основной файл проекта Diamond
├── T2MI_PPS_Generator1.sty     # Файл стратегии синтеза
├── Makefile                    # Автоматизация сборки
├── README.md                   # Данная документация
├── src/                        # Исходные файлы HDL
│   ├── t2mi_pps_top.v         # Модуль верхнего уровня
│   ├── t2mi_packet_parser.v   # Парсер T2-MI пакетов
│   ├── timestamp_extractor.v  # Извлечение временных штампов
│   ├── pps_generator.v        # Генератор PPS
│   └── sync_modules.v         # Модули синхронизации
├── constraints/               # Файлы ограничений
│   └── t2mi_pps.lpf          # Назначение выводов и тайминги
├── sim/                      # Файлы симуляции
│   └── t2mi_pps_tb.v        # Testbench
└── doc/                     # Дополнительная документация
```





